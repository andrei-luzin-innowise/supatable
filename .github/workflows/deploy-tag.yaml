name: Build on tag (FE + BE + Docker)

on:
  push:
    tags:
      - "v*"
      - "demo-*"

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: deploy-tag-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "10.0.x"
  NODE_VERSION: "20"

  CLIENT_DIR: "client"
  DOCKERFILE_PATH: "src/Supatable.Api/Dockerfile.azure"
  DOCKER_BUILD_CONTEXT: "."
  IMAGE_NAME: "supatable-api"
  EPHEMERAL_RG_PREFIX: "supatable-ephemeral-"
  EPHEMERAL_PG_DATABASE: "supatable"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve deployment mode
        id: flags
        run: |
          if [[ "${GITHUB_REF_NAME}" == demo-* ]]; then
            echo "is_demo=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_demo=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------- FE ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.CLIENT_DIR }}/package-lock.json

      - name: Install FE deps
        working-directory: ${{ env.CLIENT_DIR }}
        run: npm ci

      - name: Build FE (Vite)
        working-directory: ${{ env.CLIENT_DIR }}
        run: npm run build

      - name: Upload FE dist (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: fe-dist-${{ github.ref_name }}
          path: ${{ env.CLIENT_DIR }}/dist
          if-no-files-found: error

      # ---------- BE ----------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: "**/packages.lock.json"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test
        run: dotnet test -c Release --no-build

      # ---------- Docker build ----------
      - name: Docker build (no push)
        run: |
          TAG="${GITHUB_REF_NAME}"
          IMAGE="${IMAGE_NAME}:${TAG}"
          docker build -f "${DOCKERFILE_PATH}" -t "${IMAGE}" "${DOCKER_BUILD_CONTEXT}"
          docker images | head -n 25

      # save docker image as tar to test
      - name: Save Docker image to artifact
        run: |
          TAG="${GITHUB_REF_NAME}"
          IMAGE="${IMAGE_NAME}:${TAG}"
          mkdir -p artifacts
          docker save "${IMAGE}" | gzip > "artifacts/${IMAGE_NAME}-${TAG}.tar.gz"

      - name: Upload Docker image (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: api-image-${{ github.ref_name }}
          path: artifacts/*.tar.gz
          if-no-files-found: error

      # ---------- GHCR push ----------
      - name: Login to GHCR
        if: steps.flags.outputs.is_demo == 'true'
        run: echo "${{ github.token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag & Push to GHCR
        if: steps.flags.outputs.is_demo == 'true'
        run: |
          TAG="${GITHUB_REF_NAME}"
          IMAGE_LOCAL="${IMAGE_NAME}:${TAG}"
          IMAGE_GHCR="ghcr.io/${{ github.repository_owner }}/supatable-api:${TAG}"

          docker tag "${IMAGE_LOCAL}" "${IMAGE_GHCR}"
          docker push "${IMAGE_GHCR}"

      # ---------- Azure App Service ----------
      - name: Azure Login
        if: steps.flags.outputs.is_demo == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve target Azure names
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          RG="${EPHEMERAL_RG_PREFIX}${TAG}"
          WEBAPP="${RG}-api"
          HASH="$(echo -n "${AZURE_SUBSCRIPTION_ID}-${RG}" | sha256sum | cut -c1-6)"
          TAG_SLUG="$(echo "${TAG}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"
          KV_BASE="supa-${TAG_SLUG}-${HASH}-kv"
          KV_NAME="$(echo "${KV_BASE}" | cut -c1-24 | sed 's/-$//')"
          LAW_BASE="supa-${TAG_SLUG}-${HASH}-law"
          LAW_NAME="$(echo "${LAW_BASE}" | cut -c1-63 | sed 's/-$//')"
          AI_BASE="supa-${TAG_SLUG}-${HASH}-ai"
          AI_NAME="$(echo "${AI_BASE}" | cut -c1-63 | sed 's/-$//')"

          if [ -z "${RG}" ] || [ -z "${WEBAPP}" ] || [ -z "${KV_NAME}" ] || [ -z "${LAW_NAME}" ] || [ -z "${AI_NAME}" ]; then
            echo "Resolved names are empty. Check secrets and tag naming."
            exit 1
          fi

          echo "AZURE_RESOURCE_GROUP=${RG}" >> "$GITHUB_ENV"
          echo "AZURE_WEBAPP_NAME=${WEBAPP}" >> "$GITHUB_ENV"
          echo "AZURE_KEYVAULT_NAME=${KV_NAME}" >> "$GITHUB_ENV"
          echo "AZURE_LOG_ANALYTICS_NAME=${LAW_NAME}" >> "$GITHUB_ENV"
          echo "AZURE_APPINSIGHTS_NAME=${AI_NAME}" >> "$GITHUB_ENV"
          echo "Resolved RG=${RG}, WEBAPP=${WEBAPP}, KV=${KV_NAME}, LAW=${LAW_NAME}, AI=${AI_NAME}"

      - name: Ensure ephemeral App Service exists (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
          AZURE_APP_SERVICE_PLAN_SKU: ${{ secrets.AZURE_APP_SERVICE_PLAN_SKU }}
        run: |
          set -euo pipefail
          LOCATION="${AZURE_LOCATION:-westeurope}"
          SKU="${AZURE_APP_SERVICE_PLAN_SKU:-B1}"
          PLAN="${AZURE_RESOURCE_GROUP}-plan"

          az group create --name "${AZURE_RESOURCE_GROUP}" --location "${LOCATION}" 1>/dev/null
          az appservice plan create \
            --name "${PLAN}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --location "${LOCATION}" \
            --sku "${SKU}" \
            --is-linux 1>/dev/null

          if ! az webapp show --resource-group "${AZURE_RESOURCE_GROUP}" --name "${AZURE_WEBAPP_NAME}" 1>/dev/null 2>&1; then
            az webapp create \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --plan "${PLAN}" \
              --name "${AZURE_WEBAPP_NAME}" \
              --deployment-container-image-name "mcr.microsoft.com/azuredocs/aci-helloworld" 1>/dev/null
          fi

      - name: Ensure ephemeral Azure PostgreSQL exists (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
          AZURE_PG_ADMIN_USER: ${{ secrets.AZURE_PG_ADMIN_USER }}
          AZURE_PG_ADMIN_PASSWORD: ${{ secrets.AZURE_PG_ADMIN_PASSWORD }}
          AZURE_PG_SKU: ${{ secrets.AZURE_PG_SKU }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          LOCATION="${AZURE_LOCATION:-westeurope}"
          PG_SKU="${AZURE_PG_SKU:-Standard_B1ms}"
          PG_DB="${EPHEMERAL_PG_DATABASE}"

          if [ -z "${AZURE_PG_ADMIN_USER}" ] || [ -z "${AZURE_PG_ADMIN_PASSWORD}" ]; then
            echo "AZURE_PG_ADMIN_USER / AZURE_PG_ADMIN_PASSWORD are required for demo deployments."
            exit 1
          fi

          HASH="$(echo -n "${AZURE_SUBSCRIPTION_ID}-${AZURE_RESOURCE_GROUP}" | sha256sum | cut -c1-6)"
          TAG_SLUG="$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"
          BASE="supa-${TAG_SLUG}-${HASH}-pg"
          PG_SERVER="$(echo "${BASE}" | cut -c1-63 | sed 's/-$//')"

          az group create --name "${AZURE_RESOURCE_GROUP}" --location "${LOCATION}" 1>/dev/null

          if ! az postgres flexible-server show --resource-group "${AZURE_RESOURCE_GROUP}" --name "${PG_SERVER}" 1>/dev/null 2>&1; then
            az postgres flexible-server create \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${PG_SERVER}" \
              --location "${LOCATION}" \
              --admin-user "${AZURE_PG_ADMIN_USER}" \
              --admin-password "${AZURE_PG_ADMIN_PASSWORD}" \
              --sku-name "${PG_SKU}" \
              --version "16" \
              --yes 1>/dev/null
          fi

          if ! az postgres flexible-server firewall-rule show --resource-group "${AZURE_RESOURCE_GROUP}" --name "${PG_SERVER}" --rule-name allow-azure-services 1>/dev/null 2>&1; then
            az postgres flexible-server firewall-rule create \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${PG_SERVER}" \
              --rule-name allow-azure-services \
              --start-ip-address 0.0.0.0 \
              --end-ip-address 0.0.0.0 1>/dev/null
          fi

          if ! az postgres flexible-server db show --resource-group "${AZURE_RESOURCE_GROUP}" --server-name "${PG_SERVER}" --database-name "${PG_DB}" 1>/dev/null 2>&1; then
            az postgres flexible-server db create \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --server-name "${PG_SERVER}" \
              --database-name "${PG_DB}" 1>/dev/null
          fi

          echo "EPHEMERAL_PG_SERVER=${PG_SERVER}" >> "$GITHUB_ENV"
          echo "EPHEMERAL_PG_DATABASE=${PG_DB}" >> "$GITHUB_ENV"

      - name: Resolve DB connection string for App Service
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_PG_ADMIN_USER: ${{ secrets.AZURE_PG_ADMIN_USER }}
          AZURE_PG_ADMIN_PASSWORD: ${{ secrets.AZURE_PG_ADMIN_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${EPHEMERAL_PG_SERVER:-}" ] || [ -z "${EPHEMERAL_PG_DATABASE:-}" ]; then
            echo "EPHEMERAL_PG_SERVER / EPHEMERAL_PG_DATABASE not set."
            exit 1
          fi
          RESOLVED="Host=${EPHEMERAL_PG_SERVER}.postgres.database.azure.com;Port=5432;Database=${EPHEMERAL_PG_DATABASE};Username=${AZURE_PG_ADMIN_USER};Password=${AZURE_PG_ADMIN_PASSWORD};SSL Mode=Require;Trust Server Certificate=true"

          if [ -z "${RESOLVED}" ]; then
            echo "Resolved DB connection string is empty."
            exit 1
          fi

          echo "RESOLVED_CONNECTION_STRING_DEFAULT=${RESOLVED}" >> "$GITHUB_ENV"

      - name: Ensure Key Vault exists (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
        run: |
          set -euo pipefail
          LOCATION="${AZURE_LOCATION:-westeurope}"
          az keyvault create \
            --name "${AZURE_KEYVAULT_NAME}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --location "${LOCATION}" \
            --enable-rbac-authorization true 1>/dev/null

      - name: Ensure Log Analytics and App Insights exist (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        env:
          AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
        run: |
          set -euo pipefail
          LOCATION="${AZURE_LOCATION:-westeurope}"

          az monitor log-analytics workspace create \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --workspace-name "${AZURE_LOG_ANALYTICS_NAME}" \
            --location "${LOCATION}" 1>/dev/null

          LAW_ID="$(az monitor log-analytics workspace show --resource-group "${AZURE_RESOURCE_GROUP}" --workspace-name "${AZURE_LOG_ANALYTICS_NAME}" --query id -o tsv)"

          if ! az monitor app-insights component show --app "${AZURE_APPINSIGHTS_NAME}" --resource-group "${AZURE_RESOURCE_GROUP}" 1>/dev/null 2>&1; then
            az monitor app-insights component create \
              --app "${AZURE_APPINSIGHTS_NAME}" \
              --location "${LOCATION}" \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --kind web \
              --workspace "${LAW_ID}" \
              --application-type web 1>/dev/null
          fi

          AI_CONNECTION_STRING="$(az monitor app-insights component show --app "${AZURE_APPINSIGHTS_NAME}" --resource-group "${AZURE_RESOURCE_GROUP}" --query connectionString -o tsv)"
          echo "APPLICATIONINSIGHTS_CONNECTION_STRING=${AI_CONNECTION_STRING}" >> "$GITHUB_ENV"
          echo "AZURE_LOG_ANALYTICS_ID=${LAW_ID}" >> "$GITHUB_ENV"

      - name: Grant WebApp access to Key Vault (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        run: |
          set -euo pipefail
          az webapp identity assign \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" 1>/dev/null

          PRINCIPAL_ID="$(az webapp identity show --resource-group "${AZURE_RESOURCE_GROUP}" --name "${AZURE_WEBAPP_NAME}" --query principalId -o tsv)"
          VAULT_ID="$(az keyvault show --name "${AZURE_KEYVAULT_NAME}" --query id -o tsv)"
          ROLE_COUNT="$(az role assignment list --assignee-object-id "${PRINCIPAL_ID}" --scope "${VAULT_ID}" --query "length([?roleDefinitionName=='Key Vault Secrets User'])" -o tsv)"

          if [ "${ROLE_COUNT}" = "0" ]; then
            az role assignment create \
              --assignee-object-id "${PRINCIPAL_ID}" \
              --assignee-principal-type ServicePrincipal \
              --role "Key Vault Secrets User" \
              --scope "${VAULT_ID}" 1>/dev/null
          fi

      - name: Put DB connection string into Key Vault (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        run: |
          set -euo pipefail
          az keyvault secret set \
            --vault-name "${AZURE_KEYVAULT_NAME}" \
            --name "connection-strings-default" \
            --value "${RESOLVED_CONNECTION_STRING_DEFAULT}" 1>/dev/null

      - name: Configure App Service container settings
        if: steps.flags.outputs.is_demo == 'true'
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          KV_REF="@Microsoft.KeyVault(SecretUri=https://${AZURE_KEYVAULT_NAME}.vault.azure.net/secrets/connection-strings-default)"
          az webapp config appsettings set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --settings \
              WEBSITES_PORT=8080 \
              ConnectionStrings__Default="${KV_REF}" \
              APPLICATIONINSIGHTS_CONNECTION_STRING="${APPLICATIONINSIGHTS_CONNECTION_STRING}" \
              DOCKER_REGISTRY_SERVER_URL=https://ghcr.io \
              DOCKER_REGISTRY_SERVER_USERNAME="${GHCR_USERNAME}" \
              DOCKER_REGISTRY_SERVER_PASSWORD="${GHCR_TOKEN}"

      - name: Configure App Service diagnostics to Log Analytics (demo tags)
        if: steps.flags.outputs.is_demo == 'true'
        run: |
          set -euo pipefail
          WEBAPP_ID="$(az webapp show --resource-group "${AZURE_RESOURCE_GROUP}" --name "${AZURE_WEBAPP_NAME}" --query id -o tsv)"
          DIAG_NAME="${AZURE_WEBAPP_NAME}-diag"

          az monitor diagnostic-settings create \
            --name "${DIAG_NAME}" \
            --resource "${WEBAPP_ID}" \
            --workspace "${AZURE_LOG_ANALYTICS_ID}" \
            --logs '[{"categoryGroup":"allLogs","enabled":true}]' \
            --metrics '[{"category":"AllMetrics","enabled":true}]' 1>/dev/null

      - name: Deploy container image to Azure App Service
        if: steps.flags.outputs.is_demo == 'true'
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME || github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          IMAGE_GHCR="ghcr.io/${{ github.repository_owner }}/supatable-api:${TAG}"

          az webapp config container set \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}" \
            --container-image-name "${IMAGE_GHCR}" \
            --container-registry-url "https://ghcr.io" \
            --container-registry-user "${GHCR_USERNAME}" \
            --container-registry-password "${GHCR_TOKEN}"

          az webapp restart \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --name "${AZURE_WEBAPP_NAME}"
